{% extends 'base_logged_in.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block logged_in_content %}
    <div class="main-content bgc-grey-100">
        <div class="mainContent">
            <div class="row gap-20">

                {# --- Linke Spalte: NUR Schlüsselübersicht --- #}
                <div class="col-md-3">
                    <div class="bdrs-3 ov-h bgc-white bd">
                        <div class="bgc-deep-purple-500 ta-c p-15">
                            <h4 class="c-white m-0">Schlüsselübersicht</h4>
                        </div>
                        <div class="p-0">
                            {# Scrollbarer Bereich falls viele Schlüssel #}
                            <div class="layer w-100" style="max-height: 80vh; overflow-y: auto;">
                                {% for roomId, keys in keysByRoom %}
                                    {# Raumnamen ermitteln #}
                                    {% set roomName = keys[0].room ? keys[0].room.name : 'Unbekannt' %}

                                    <div class="p-15 border-bottom">
                                        <h6 class="c-grey-900 mB-10">{{ roomName }}</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            {% for key in keys %}
                                                {% set statusColor = 'success' %}
                                                {% if key.status.value == 'borrowed' %}
                                                    {% set statusColor = 'warning' %}
                                                {% elseif key.status.value == 'lost' %}
                                                    {% set statusColor = 'danger' %}
                                                {% endif %}

                                                <button type="button"
                                                        class="btn btn-outline-{{ statusColor }} btn-sm d-flex align-items-center gap-2 key-item-btn"
                                                        data-key-id="{{ key.id }}"
                                                        data-key-name="{{ key.name }}"
                                                        data-key-status="{{ key.status.value }}"
                                                        data-borrow-date="{{ key.borrowDate ? key.borrowDate|date('Y-m-d') : '' }}"
                                                        data-return-date="{{ key.returnDate ? key.returnDate|date('Y-m-d') : '' }}"
                                                        data-user-id="{{ key.user ? key.user.id : '' }}"
                                                        data-tech-id="{{ key.technician ? key.technician.id : '' }}"
                                                        data-prod-id="{{ key.production ? key.production.id : '' }}"
                                                        data-clean-id="{{ key.cleaning ? key.cleaning.id : '' }}"
                                                        title="Name: {{ key.name }}">
                                                    <i class="ti-key"></i>
                                                    <span>{{ key.name }}</span>
                                                </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}

                                {% if keysWithoutRoom is not empty %}
                                    <div class="p-15 border-bottom">
                                        <h6 class="c-grey-900 mB-10">Ohne Raumzuordnung</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            {% for key in keysWithoutRoom %}
                                                {% set statusColor = 'success' %}
                                                {% if key.status.value == 'borrowed' %}
                                                    {% set statusColor = 'warning' %}
                                                {% elseif key.status.value == 'lost' %}
                                                    {% set statusColor = 'danger' %}
                                                {% endif %}

                                                <button type="button"
                                                        class="btn btn-outline-{{ statusColor }} btn-sm d-flex align-items-center gap-2 key-item-btn"
                                                        data-key-id="{{ key.id }}"
                                                        data-key-name="{{ key.name }}"
                                                        data-key-status="{{ key.status.value }}"
                                                        data-borrow-date="{{ key.borrowDate ? key.borrowDate|date('Y-m-d') : '' }}"
                                                        data-return-date="{{ key.returnDate ? key.returnDate|date('Y-m-d') : '' }}"
                                                        data-user-id="{{ key.user ? key.user.id : '' }}"
                                                        data-tech-id="{{ key.technician ? key.technician.id : '' }}"
                                                        data-prod-id="{{ key.production ? key.production.id : '' }}"
                                                        data-clean-id="{{ key.cleaning ? key.cleaning.id : '' }}"
                                                        title="Name: {{ key.name }}">
                                                    <i class="ti-key"></i>
                                                    <span>{{ key.name }}</span>
                                                </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {# --- Rechte Spalte: Filter & Kalender Grid --- #}
                <div class="col-md-9">
                    <div class="bgc-white p-20 bd mB-20">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <h6 class="c-grey-900 m-0">Kalender Filter</h6>
                            <div class="d-flex gap-3 flex-wrap" id="calendar-filters">
                                <div class="form-check">
                                    <input class="form-check-input filter-checkbox" type="checkbox" value="production"
                                           id="filterProduction" checked>
                                    <label class="form-check-label" for="filterProduction">Produktion</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input filter-checkbox" type="checkbox" value="technician"
                                           id="filterTechnician" checked>
                                    <label class="form-check-label" for="filterTechnician">Techniker</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input filter-checkbox" type="checkbox" value="cleaning"
                                           id="filterCleaning" checked>
                                    <label class="form-check-label" for="filterCleaning">Reinigung</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input filter-checkbox" type="checkbox" value="private"
                                           id="filterPrivate" checked>
                                    <label class="form-check-label" for="filterPrivate">Privat / Sonstiges</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        {% for room in rooms %}
                            <div class="col-12 col-xl-6 mb-4">
                                <div class="bgc-white p-15 bd h-100">
                                    <h5 class="c-grey-900 border-bottom pb-2 mB-15 text-center">{{ room.name }}</h5>
                                    <div class="room-calendar" data-room-id="{{ room.id }}"></div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {# Key Management Modal #}
        <div class="modal fade" id="keyManagementModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Schlüssel verwalten <span id="modalKeyNameTitle" class="badge bg-secondary"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="keyManagementForm">
                            <input type="hidden" id="keyId">

                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="keyStatus">
                                    <option value="available">Verfügbar</option>
                                    <option value="borrowed">Verliehen</option>
                                    <option value="lost">Verloren</option>
                                </select>
                            </div>

                            <div id="borrowDetails" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Verliehen an (Typ)</label>
                                    <select class="form-select" id="borrowerType">
                                        <option value="">Bitte wählen...</option>
                                        <option value="user">Benutzer</option>
                                        <option value="technician">Techniker</option>
                                        <option value="production">Produktion</option>
                                        <option value="cleaning">Reinigung</option>
                                    </select>
                                </div>

                                {# Benutzer Select #}
                                <div class="mb-3 borrower-select" id="userSelectDiv" style="display:none;">
                                    <label class="form-label">Benutzer</label>
                                    <select class="form-select" id="userId">
                                        <option value="">Wählen...</option>
                                        {% for u in allUsers %}
                                            <option value="{{ u.id }}">{{ u.email }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                {# Techniker Select #}
                                <div class="mb-3 borrower-select" id="technicianSelectDiv" style="display:none;">
                                    <label class="form-label">Techniker</label>
                                    <select class="form-select" id="technicianId">
                                        <option value="">Wählen...</option>
                                        {% for t in allTechnicians %}
                                            <option value="{{ t.id }}">{{ t.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                {# Produktion Select #}
                                <div class="mb-3 borrower-select" id="productionSelectDiv" style="display:none;">
                                    <label class="form-label">Produktion</label>
                                    <select class="form-select" id="productionId">
                                        <option value="">Wählen...</option>
                                        {% for p in allProductions %}
                                            <option value="{{ p.id }}">{{ p.displayName }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                {# Reinigung Select #}
                                <div class="mb-3 borrower-select" id="cleaningSelectDiv" style="display:none;">
                                    <label class="form-label">Reinigung</label>
                                    <select class="form-select" id="cleaningId">
                                        <option value="">Wählen...</option>
                                        {% for c in allCleanings %}
                                            <option value="{{ c.id }}">{{ c.id }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Ausgabedatum</label>
                                    <input type="date" class="form-control" id="keyBorrowDate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Rückgabedatum (geplant)</label>
                                    <input type="date" class="form-control" id="keyReturnDate">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="button" class="btn btn-primary" id="saveKeyBtn">Speichern</button>
                    </div>
                </div>
            </div>
        </div>

        {# Modal für Termin erstellen/bearbeiten - unverändert #}
        <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="appointmentModalLabel">Neuer Termin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="appointmentForm">
                            <input type="hidden" id="appointmentId">
                            <input type="hidden" id="appointmentColor" value="#4285f4">

                            <div class="mb-3">
                                <label class="form-label d-block">Art des Termins</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input type-radio" type="radio" name="appointmentType" id="typePrivate" value="private" checked>
                                    <label class="form-check-label" for="typePrivate">Privat</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input type-radio" type="radio" name="appointmentType" id="typeCleaning" value="cleaning">
                                    <label class="form-check-label" for="typeCleaning">Reinigung</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input type-radio" type="radio" name="appointmentType" id="typeTechnician" value="technician">
                                    <label class="form-check-label" for="typeTechnician">Techniker</label>
                                </div>
                            </div>

                            <div class="mb-3" id="titleGroup">
                                <label for="appointmentTitle" class="form-label">Titel *</label>
                                <input type="text" class="form-control" id="appointmentTitle">
                            </div>

                            <div class="mb-3">
                                <label for="appointmentRoom" class="form-label">Raum</label>
                                <select class="form-select" id="appointmentRoom">
                                    <option value="">-- Kein Raum (Global) --</option>
                                    {% for room in rooms %}
                                        <option value="{{ room.id }}">{{ room.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Raumzuweisung (optional)</div>
                            </div>

                            {# Reinigung Auswahl #}
                            <div class="mb-3" id="cleaningSelectGroup" style="display:none;">
                                <label for="appointmentCleaning" class="form-label">Reinigungskraft / Team</label>
                                <select class="form-select" id="appointmentCleaning">
                                    <option value="">Bitte wählen...</option>
                                    {% for c in allCleanings %}
                                        <option value="{{ c.id }}">Reinigung #{{ c.id }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            {# Techniker Auswahl #}
                            <div class="mb-3" id="technicianSelectGroup" style="display:none;">
                                <label for="appointmentTechnician" class="form-label">Techniker</label>
                                <select class="form-select" id="appointmentTechnician">
                                    <option value="">Bitte wählen...</option>
                                    {% for t in allTechnicians %}
                                        <option value="{{ t.id }}">{{ t.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="appointmentDescription" class="form-label">Beschreibung</label>
                                <textarea class="form-control" id="appointmentDescription" rows="3"></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="appointmentStart" class="form-label">Start *</label>
                                <input type="datetime-local" class="form-control" id="appointmentStart" required>
                            </div>

                            <div class="mb-3">
                                <label for="appointmentEnd" class="form-label">Ende *</label>
                                <input type="datetime-local" class="form-control" id="appointmentEnd" required>
                            </div>

                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="appointmentAllDay">
                                <label class="form-check-label" for="appointmentAllDay">Ganztägig</label>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Farbe</label>
                                <div class="d-flex gap-2 flex-wrap">
                                    <div class="color-option selected" data-color="#4285f4" style="width: 40px; height: 40px; background-color: #4285f4; border-radius: 5px; cursor: pointer; border: 3px solid transparent;"></div>
                                    <div class="color-option" data-color="#0f9d58" style="width: 40px; height: 40px; background-color: #0f9d58; border-radius: 5px; cursor: pointer; border: 3px solid transparent;"></div>
                                    <div class="color-option" data-color="#f4b400" style="width: 40px; height: 40px; background-color: #f4b400; border-radius: 5px; cursor: pointer; border: 3px solid transparent;"></div>
                                    <div class="color-option" data-color="#db4437" style="width: 40px; height: 40px; background-color: #db4437; border-radius: 5px; cursor: pointer; border: 3px solid transparent;"></div>
                                    <div class="color-option" data-color="#ab47bc" style="width: 40px; height: 40px; background-color: #ab47bc; border-radius: 5px; cursor: pointer; border: 3px solid transparent;"></div>
                                    <div class="color-option" data-color="#00acc1" style="width: 40px; height: 40px; background-color: #00acc1; border-radius: 5px; cursor: pointer; border: 3px solid transparent;"></div>
                                    <div class="color-option" data-color="#ff7043" style="width: 40px; height: 40px; background-color: #ff7043; border-radius: 5px; cursor: pointer; border: 3px solid transparent;"></div>
                                    <div class="color-option" data-color="#9e9e9e" style="width: 40px; height: 40px; background-color: #9e9e9e; border-radius: 5px; cursor: pointer; border: 3px solid transparent;"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="button" class="btn btn-danger" id="deleteAppointmentBtn" style="display: none;">Löschen</button>
                        <button type="button" class="btn btn-primary" id="saveAppointmentBtn">Speichern</button>
                    </div>
                </div>
            </div>
        </div>

        {# Production Event Details Modal #}
        <div class="modal fade" id="productionEventModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="productionEventModalTitle">Veranstaltung</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="productionEventModalBody">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Laden...</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                        <a href="#" id="editProductionEventBtn" class="btn btn-primary" style="display: none;">Bearbeiten</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
